# 语音播放问题排查指南

## 问题描述
在语音面试时，面试官说话时没有声音。

## 已实施的修复措施

### 1. 前端音频播放改进
- **添加了完整的错误处理**：捕获并显示具体的播放错误
- **处理浏览器自动播放策略**：检测 NotAllowedError 并提示用户点击页面
- **确保音频设置正确**：
  - 设置音量为 1.0
  - 确保 muted = false
  - 添加 crossOrigin="anonymous" 处理 CORS

### 2. 调试功能增强
- **添加调试模式**：可以显示音频控件查看实际状态
- **详细的控制台日志**：记录音频加载、播放、错误等事件
- **测试按钮**：可以手动触发语音合成测试

### 3. 时序优化
- **延迟初始播放**：确保组件完全加载后再播放欢迎语音
- **异步状态更新处理**：等待 store 更新后再播放新问题

## 排查步骤

### 1. 检查后端服务
```bash
# 1. 确保后端服务正在运行
cd backend
uvicorn main:app --reload --host 0.0.0.0 --port 8000

# 2. 测试语音合成 API
python test_audio_playback.py
```

### 2. 检查浏览器控制台
1. 打开浏览器开发者工具（F12）
2. 查看 Console 标签页的错误信息
3. 查看 Network 标签页，确认 /speech/synthesize 请求是否成功

### 3. 常见问题及解决方案

#### 问题 1: 浏览器自动播放策略
**症状**：控制台显示 "NotAllowedError"

**解决方案**：
- 点击页面任意位置以启用音频播放
- 或者先与页面进行交互（如点击按钮）

#### 问题 2: CORS 错误
**症状**：控制台显示跨域错误

**解决方案**：
- 确保后端设置了正确的 CORS 头
- 检查 audio 元素的 crossOrigin 属性

#### 问题 3: 音频格式不支持
**症状**：音频元素 error 事件触发

**解决方案**：
- 确认返回的是 MP3 格式
- 检查 Content-Type 是否为 "audio/mpeg"

#### 问题 4: API 密钥问题
**症状**：语音合成 API 返回错误

**解决方案**：
- 检查 .env 文件中的 OPENAI_API_KEY
- 确认 API 密钥有效且有 TTS 权限

### 4. 测试方法

#### 方法 1: 使用测试按钮
1. 进入语音面试界面
2. 点击"测试语音"按钮
3. 观察是否有声音播放

#### 方法 2: 开启调试模式
1. 点击"开启调试"按钮
2. 查看音频控件是否显示
3. 手动点击播放按钮测试

#### 方法 3: 直接测试 API
```bash
curl -X POST http://localhost:8000/speech/synthesize \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "text=测试语音&voice=nova&speed=1.0" \
  -o test.mp3
```

## 配置检查清单

- [ ] 后端服务正在运行
- [ ] OpenAI API 密钥配置正确
- [ ] 浏览器允许音频播放
- [ ] 系统音量开启
- [ ] 网络连接正常

## 日志位置
- **前端日志**：浏览器控制台
- **后端日志**：终端输出或 logs/app.log
- **网络请求**：浏览器 Network 标签页

## 联系支持
如果以上方法都无法解决问题，请提供以下信息：
1. 浏览器版本和类型
2. 控制台错误截图
3. Network 标签页中 /speech/synthesize 请求的详情
4. 后端服务日志 