<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VITAè¯­éŸ³é¢è¯• - Edge/Chromeå…¼å®¹æ€§æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .browser-info {
            background: #f8f9fa;
            padding: 20px;
            border-left: 4px solid #007bff;
            margin: 20px;
            border-radius: 5px;
        }

        .test-section {
            padding: 30px;
        }

        .test-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-card h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .test-card .status {
            margin-left: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status.ready { background: #e3f2fd; color: #1976d2; }
        .status.testing { background: #fff3e0; color: #f57c00; }
        .status.success { background: #e8f5e8; color: #4caf50; }
        .status.error { background: #ffebee; color: #f44336; }

        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .log-panel {
            background: #000;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }

        audio {
            flex: 1;
            height: 40px;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .voice-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 15px 0;
        }

        .voice-wave {
            width: 20px;
            height: 20px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .compatibility-info {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .compatibility-info h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .browser-badge {
            display: inline-block;
            padding: 5px 12px;
            background: #007bff;
            color: white;
            border-radius: 15px;
            font-size: 0.9em;
            margin: 5px;
        }

        .emoji {
            font-size: 1.2em;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ VITAè¯­éŸ³é¢è¯•æµ‹è¯•</h1>
            <p>Edgeæµè§ˆå™¨å’ŒChromeæµè§ˆå™¨å…¼å®¹æ€§éªŒè¯</p>
        </div>

        <div class="browser-info">
            <h4>ğŸŒ æµè§ˆå™¨å…¼å®¹æ€§ä¿¡æ¯</h4>
            <p><strong>å½“å‰æµè§ˆå™¨:</strong> <span id="browserInfo">æ£€æµ‹ä¸­...</span></p>
            <p><strong>æ¨èæµè§ˆå™¨:</strong> 
                <span class="browser-badge">Google Chrome</span>
                <span class="browser-badge">Microsoft Edge</span>
            </p>
        </div>

        <div class="test-section">
            <!-- TTSæ’­æ”¾æµ‹è¯• -->
            <div class="test-card">
                <h3>
                    <span class="emoji">ğŸ”Š</span>
                    TTSè¯­éŸ³æ’­æ”¾æµ‹è¯•
                    <span class="status ready" id="ttsStatus">å‡†å¤‡å°±ç»ª</span>
                </h3>
                <p>æµ‹è¯•VITAçš„æ–‡å­—è½¬è¯­éŸ³åŠŸèƒ½ï¼ŒéªŒè¯ç”¨æˆ·èƒ½å¦å¬åˆ°é¢è¯•å®˜çš„é—®é¢˜ã€‚</p>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="testTTS()">
                        <span class="emoji">â–¶ï¸</span>æ’­æ”¾æµ‹è¯•è¯­éŸ³
                    </button>
                    <button class="btn btn-warning" onclick="testDifferentVoices()">
                        <span class="emoji">ğŸ­</span>æµ‹è¯•ä¸åŒå£°éŸ³
                    </button>
                </div>

                <div class="audio-controls">
                    <audio id="ttsAudio" controls style="display: none;">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                    </audio>
                    <button class="btn btn-success" id="playBtn" onclick="playAudio()" style="display: none;">
                        <span class="emoji">ğŸ”Š</span>æ’­æ”¾
                    </button>
                </div>
            </div>

            <!-- éº¦å…‹é£æƒé™æµ‹è¯• -->
            <div class="test-card">
                <h3>
                    <span class="emoji">ğŸ™ï¸</span>
                    éº¦å…‹é£æƒé™æµ‹è¯•
                    <span class="status ready" id="micStatus">å‡†å¤‡å°±ç»ª</span>
                </h3>
                <p>æµ‹è¯•æµè§ˆå™¨éº¦å…‹é£æƒé™ï¼Œç¡®ä¿å¯ä»¥å½•åˆ¶ç”¨æˆ·çš„è¯­éŸ³å›ç­”ã€‚</p>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="testMicrophone()">
                        <span class="emoji">ğŸ¤</span>æµ‹è¯•éº¦å…‹é£
                    </button>
                    <button class="btn btn-danger" onclick="stopRecording()" id="stopBtn" style="display: none;">
                        <span class="emoji">â¹ï¸</span>åœæ­¢å½•åˆ¶
                    </button>
                </div>

                <div class="voice-indicator" id="voiceIndicator" style="display: none;">
                    <div class="voice-wave"></div>
                    <span>æ­£åœ¨å½•åˆ¶è¯­éŸ³...</span>
                </div>
            </div>

            <!-- å®Œæ•´é¢è¯•æµç¨‹æµ‹è¯• -->
            <div class="test-card">
                <h3>
                    <span class="emoji">ğŸ’¼</span>
                    å®Œæ•´é¢è¯•æµç¨‹æµ‹è¯•
                    <span class="status ready" id="interviewStatus">å‡†å¤‡å°±ç»ª</span>
                </h3>
                <p>æ¨¡æ‹Ÿå®Œæ•´çš„è¯­éŸ³é¢è¯•æµç¨‹ï¼ŒåŒ…æ‹¬AIé—®é¢˜æ’­æ”¾å’Œç”¨æˆ·è¯­éŸ³å›ç­”ã€‚</p>
                
                <div class="controls">
                    <button class="btn btn-success" onclick="startInterview()">
                        <span class="emoji">ğŸš€</span>å¼€å§‹é¢è¯•
                    </button>
                    <button class="btn btn-warning" onclick="pauseInterview()" id="pauseBtn" style="display: none;">
                        <span class="emoji">â¸ï¸</span>æš‚åœ
                    </button>
                    <button class="btn btn-danger" onclick="stopInterview()" id="stopInterviewBtn" style="display: none;">
                        <span class="emoji">ğŸ›‘</span>ç»“æŸé¢è¯•
                    </button>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="interviewProgress"></div>
                </div>
                <p>é¢è¯•è¿›åº¦: <span id="progressText">0/5 é—®é¢˜</span></p>
            </div>

            <!-- å…¼å®¹æ€§æŠ¥å‘Š -->
            <div class="compatibility-info">
                <h4>âœ… å…¼å®¹æ€§éªŒè¯ç»“æœ</h4>
                <ul id="compatibilityResults">
                    <li>ç­‰å¾…æµ‹è¯•ç»“æœ...</li>
                </ul>
            </div>

            <!-- æ—¥å¿—é¢æ¿ -->
            <div class="log-panel" id="logPanel">
                VITAè¯­éŸ³é¢è¯•æµ‹è¯•æ§åˆ¶å°
                ========================
                ç­‰å¾…æµ‹è¯•å¼€å§‹...
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let interviewQuestions = [
            "æ¬¢è¿å‚åŠ VITAè™šæ‹Ÿé¢è¯•ï¼Œè¯·å…ˆç®€å•ä»‹ç»ä¸€ä¸‹æ‚¨è‡ªå·±ã€‚",
            "è¯·è°ˆè°ˆæ‚¨çš„å·¥ä½œç»éªŒå’ŒæŠ€èƒ½ä¸“é•¿ã€‚", 
            "æ‚¨ä¸ºä»€ä¹ˆå¯¹è¿™ä¸ªèŒä½æ„Ÿå…´è¶£ï¼Ÿ",
            "è¯·æè¿°ä¸€ä¸‹æ‚¨æœ€å¤§çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆã€‚",
            "æ‚¨æœ‰ä»€ä¹ˆé—®é¢˜æƒ³è¦é—®æˆ‘ä»¬çš„å—ï¼Ÿ"
        ];
        let currentQuestion = 0;
        let interviewActive = false;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            detectBrowser();
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œç³»ç»Ÿåˆå§‹åŒ–ä¸­...');
            checkBrowserCompatibility();
        });

        // æµè§ˆå™¨æ£€æµ‹
        function detectBrowser() {
            const userAgent = navigator.userAgent;
            let browserName = 'æœªçŸ¥æµè§ˆå™¨';
            let isSupported = false;

            if (userAgent.indexOf('Chrome') > -1 && userAgent.indexOf('Edg') === -1) {
                browserName = 'Google Chrome âœ…';
                isSupported = true;
            } else if (userAgent.indexOf('Edg') > -1) {
                browserName = 'Microsoft Edge âœ…';
                isSupported = true;
            } else if (userAgent.indexOf('Firefox') > -1) {
                browserName = 'Mozilla Firefox âš ï¸';
                isSupported = true;
            } else if (userAgent.indexOf('Safari') > -1) {
                browserName = 'Safari âš ï¸';
                isSupported = false;
            }

            document.getElementById('browserInfo').textContent = browserName;
            
            if (isSupported) {
                log(`âœ… æ£€æµ‹åˆ°æ”¯æŒçš„æµè§ˆå™¨: ${browserName}`);
            } else {
                log(`âš ï¸ å½“å‰æµè§ˆå™¨å¯èƒ½å­˜åœ¨å…¼å®¹æ€§é—®é¢˜: ${browserName}`);
            }
        }

        // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
        function checkBrowserCompatibility() {
            const results = [];
            
            // æ£€æŸ¥Web Audio API
            if (window.AudioContext || window.webkitAudioContext) {
                results.push('âœ… Web Audio API æ”¯æŒ');
                log('âœ… Web Audio API å¯ç”¨');
            } else {
                results.push('âŒ Web Audio API ä¸æ”¯æŒ');
                log('âŒ Web Audio API ä¸å¯ç”¨');
            }

            // æ£€æŸ¥MediaRecorder API
            if (window.MediaRecorder) {
                results.push('âœ… MediaRecorder API æ”¯æŒ');
                log('âœ… MediaRecorder API å¯ç”¨');
            } else {
                results.push('âŒ MediaRecorder API ä¸æ”¯æŒ');
                log('âŒ MediaRecorder API ä¸å¯ç”¨');
            }

            // æ£€æŸ¥getUserMedia
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                results.push('âœ… éº¦å…‹é£è®¿é—® API æ”¯æŒ');
                log('âœ… getUserMedia API å¯ç”¨');
            } else {
                results.push('âŒ éº¦å…‹é£è®¿é—® API ä¸æ”¯æŒ');
                log('âŒ getUserMedia API ä¸å¯ç”¨');
            }

            // æ›´æ–°å…¼å®¹æ€§ç»“æœæ˜¾ç¤º
            const resultsList = document.getElementById('compatibilityResults');
            resultsList.innerHTML = results.map(result => `<li>${result}</li>`).join('');
        }

        // TTSæµ‹è¯•
        async function testTTS() {
            setStatus('ttsStatus', 'testing', 'æµ‹è¯•ä¸­');
            log('ğŸ”Š å¼€å§‹TTSæµ‹è¯•...');

            // å°è¯•å¤šç§éŸ³é¢‘æ ¼å¼ - WAVä¼˜å…ˆ
            const endpoints = [
                { url: 'http://localhost:8000/speech/synthesize-wav', format: 'WAV', mimeType: 'audio/wav' },
                { url: 'http://localhost:8000/speech/synthesize', format: 'MP3', mimeType: 'audio/mpeg' }
            ];

            for (const endpoint of endpoints) {
                try {
                    log(`ğŸµ å°è¯•${endpoint.format}æ ¼å¼...`);
                    
                    const response = await fetch(endpoint.url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            text: 'æ‚¨å¥½ï¼Œè¿™æ˜¯VITAè¯­éŸ³é¢è¯•çš„TTSæµ‹è¯•ã€‚å¦‚æœæ‚¨èƒ½å¬åˆ°è¿™æ®µè¯ï¼Œè¯´æ˜æ‚¨çš„æµè§ˆå™¨å®Œå…¨æ”¯æŒæˆ‘ä»¬çš„è¯­éŸ³åŠŸèƒ½ã€‚',
                            voice: 'nova',
                            speed: '1.0'
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    // è·å–å“åº”å¤´ä¿¡æ¯
                    const contentType = response.headers.get('Content-Type');
                    const contentLength = response.headers.get('Content-Length');
                    log(`ğŸ“„ ${endpoint.format}å“åº”å¤´ - Content-Type: ${contentType}, Content-Length: ${contentLength}`);

                    const audioBlob = await response.blob();
                    log(`âœ… ${endpoint.format}éŸ³é¢‘ç”ŸæˆæˆåŠŸ: ${audioBlob.size} å­—èŠ‚, Blobç±»å‹: ${audioBlob.type}`);

                    // éªŒè¯éŸ³é¢‘æ•°æ®
                    if (audioBlob.size === 0) {
                        throw new Error('éŸ³é¢‘æ•°æ®ä¸ºç©º');
                    }

                    // åˆ›å»ºéŸ³é¢‘URL
                    const audioUrl = URL.createObjectURL(audioBlob);
                    log(`ğŸ”— ${endpoint.format}åˆ›å»ºBlob URL: ${audioUrl.substring(0, 50)}...`);

                    // å°è¯•ç›´æ¥æ’­æ”¾
                    try {
                        log(`ğŸµ å°è¯•${endpoint.format}æ ¼å¼æ’­æ”¾...`);
                        const audio = new Audio();
                        
                        // æ·»åŠ è¯¦ç»†çš„äº‹ä»¶ç›‘å¬å™¨
                        audio.addEventListener('loadstart', () => log(`ğŸ¶ ${endpoint.format}éŸ³é¢‘å¼€å§‹åŠ è½½`));
                        audio.addEventListener('loadedmetadata', () => log(`ğŸ¶ ${endpoint.format}éŸ³é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ: ${audio.duration}ç§’`));
                        audio.addEventListener('loadeddata', () => log(`ğŸ¶ ${endpoint.format}éŸ³é¢‘æ•°æ®åŠ è½½å®Œæˆ`));
                        audio.addEventListener('canplay', () => log(`ğŸ¶ ${endpoint.format}éŸ³é¢‘å¯ä»¥æ’­æ”¾`));
                        audio.addEventListener('canplaythrough', () => log(`ğŸ¶ ${endpoint.format}éŸ³é¢‘å¯ä»¥è¿ç»­æ’­æ”¾`));
                        audio.addEventListener('play', () => log(`ğŸ¶ ${endpoint.format}éŸ³é¢‘å¼€å§‹æ’­æ”¾`));
                        audio.addEventListener('pause', () => log(`ğŸ¶ ${endpoint.format}éŸ³é¢‘æš‚åœ`));
                        audio.addEventListener('ended', () => log(`ğŸ¶ ${endpoint.format}éŸ³é¢‘æ’­æ”¾ç»“æŸ`));
                        audio.addEventListener('error', (e) => {
                            const error = audio.error;
                            log(`âŒ ${endpoint.format}Audioæ’­æ”¾é”™è¯¯: code=${error.code}, message=${error.message || 'æœªçŸ¥é”™è¯¯'}`);
                        });

                        // è®¾ç½®éŸ³é¢‘æº
                        audio.src = audioUrl;
                        
                        // ç­‰å¾…å…ƒæ•°æ®åŠ è½½
                        await new Promise((resolve, reject) => {
                            const timeout = setTimeout(() => {
                                reject(new Error('éŸ³é¢‘åŠ è½½è¶…æ—¶'));
                            }, 10000);
                            
                            audio.addEventListener('loadedmetadata', () => {
                                clearTimeout(timeout);
                                resolve();
                            });
                            
                            audio.addEventListener('error', () => {
                                clearTimeout(timeout);
                                reject(new Error('éŸ³é¢‘åŠ è½½å¤±è´¥'));
                            });
                            
                            audio.load(); // å¼ºåˆ¶åŠ è½½
                        });

                        // å°è¯•æ’­æ”¾
                        await audio.play();
                        log(`ğŸ‰ ${endpoint.format}æ ¼å¼æ’­æ”¾æˆåŠŸï¼`);
                        
                        // è®¾ç½®åˆ°é¡µé¢å…ƒç´ 
                        const audioElement = document.getElementById('ttsAudio');
                        audioElement.src = audioUrl;
                        audioElement.style.display = 'block';
                        document.getElementById('playBtn').style.display = 'inline-flex';

                        setStatus('ttsStatus', 'success', `${endpoint.format}æ ¼å¼æˆåŠŸ`);
                        log(`ğŸ‰ TTSæµ‹è¯•å®Œæˆï¼Œä½¿ç”¨${endpoint.format}æ ¼å¼`);
                        return; // æˆåŠŸå°±é€€å‡ºå¾ªç¯

                    } catch (playError) {
                        log(`âŒ ${endpoint.format}æ ¼å¼æ’­æ”¾å¤±è´¥: ${playError.message}`);
                        // å°è¯•ä¸‹ä¸€ä¸ªæ ¼å¼
                        continue;
                    }

                } catch (error) {
                    log(`âŒ ${endpoint.format}æ ¼å¼æµ‹è¯•å¤±è´¥: ${error.message}`);
                    // å°è¯•ä¸‹ä¸€ä¸ªæ ¼å¼
                    continue;
                }
            }
            
            // æ‰€æœ‰æ ¼å¼éƒ½å¤±è´¥äº†
            log('âŒ æ‰€æœ‰éŸ³é¢‘æ ¼å¼éƒ½æµ‹è¯•å¤±è´¥');
            setStatus('ttsStatus', 'error', 'æ‰€æœ‰æ ¼å¼å¤±è´¥');
        }

        // æ’­æ”¾éŸ³é¢‘
        function playAudio() {
            const audioElement = document.getElementById('ttsAudio');
            audioElement.play().then(() => {
                log('ğŸ”Š éŸ³é¢‘æ’­æ”¾å¼€å§‹');
            }).catch(error => {
                log(`âŒ éŸ³é¢‘æ’­æ”¾å¤±è´¥: ${error.message}`);
            });
        }

        // æµ‹è¯•ä¸åŒå£°éŸ³
        async function testDifferentVoices() {
            const voices = ['nova', 'echo', 'alloy', 'shimmer'];
            const texts = [
                'æ‚¨å¥½ï¼Œæˆ‘æ˜¯Novaï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚',
                'å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯Echoï¼Œä¸“ä¸šçš„é¢è¯•åŠ©æ‰‹ã€‚',
                'æ¬¢è¿ä½¿ç”¨VITAï¼Œæˆ‘æ˜¯Alloyè¯­éŸ³åŠ©æ‰‹ã€‚',
                'æ‚¨å¥½ï¼Œæˆ‘æ˜¯Shimmerï¼ŒæœŸå¾…ä¸æ‚¨çš„äº¤æµã€‚'
            ];

            for (let i = 0; i < voices.length; i++) {
                log(`ğŸ­ æµ‹è¯•è¯­éŸ³: ${voices[i]}`);
                
                try {
                    const response = await fetch('http://localhost:8000/speech/synthesize', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            text: texts[i],
                            voice: voices[i],
                            speed: '1.0'
                        })
                    });

                    if (response.ok) {
                        const audioBlob = await response.blob();
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioUrl);
                        
                        log(`âœ… ${voices[i]} è¯­éŸ³ç”ŸæˆæˆåŠŸï¼Œæ’­æ”¾ä¸­...`);
                        await audio.play();
                        
                        // ç­‰å¾…æ’­æ”¾å®Œæˆ
                        await new Promise(resolve => {
                            audio.onended = resolve;
                        });
                    }
                } catch (error) {
                    log(`âŒ ${voices[i]} è¯­éŸ³æµ‹è¯•å¤±è´¥: ${error.message}`);
                }
            }
            
            log('ğŸ­ æ‰€æœ‰è¯­éŸ³æµ‹è¯•å®Œæˆ');
        }

        // éº¦å…‹é£æµ‹è¯•
        async function testMicrophone() {
            setStatus('micStatus', 'testing', 'è¯·æ±‚æƒé™');
            log('ğŸ¤ å¼€å§‹éº¦å…‹é£æµ‹è¯•...');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000
                    } 
                });

                log('âœ… éº¦å…‹é£æƒé™è·å–æˆåŠŸ');
                setStatus('micStatus', 'success', 'æƒé™å·²è·å–');

                // å¼€å§‹å½•åˆ¶
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    log(`ğŸµ å½•åˆ¶å®Œæˆï¼ŒéŸ³é¢‘å¤§å°: ${audioBlob.size} å­—èŠ‚`);
                    
                    // æ’­æ”¾å½•åˆ¶çš„éŸ³é¢‘
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                    log('ğŸ”Š æ’­æ”¾å½•åˆ¶çš„éŸ³é¢‘');
                };

                mediaRecorder.start();
                isRecording = true;

                document.getElementById('voiceIndicator').style.display = 'flex';
                document.getElementById('stopBtn').style.display = 'inline-flex';
                
                log('ğŸ™ï¸ å½•åˆ¶å¼€å§‹ï¼Œè¯·è¯´è¯...');
                setStatus('micStatus', 'testing', 'å½•åˆ¶ä¸­');

                // 5ç§’åè‡ªåŠ¨åœæ­¢
                setTimeout(() => {
                    if (isRecording) {
                        stopRecording();
                    }
                }, 5000);

            } catch (error) {
                log(`âŒ éº¦å…‹é£æµ‹è¯•å¤±è´¥: ${error.message}`);
                setStatus('micStatus', 'error', 'æƒé™è¢«æ‹’ç»');
            }
        }

        // åœæ­¢å½•åˆ¶
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                document.getElementById('voiceIndicator').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'none';
                
                setStatus('micStatus', 'success', 'å½•åˆ¶å®Œæˆ');
                log('â¹ï¸ å½•åˆ¶åœæ­¢');
            }
        }

        // å¼€å§‹é¢è¯•
        async function startInterview() {
            interviewActive = true;
            currentQuestion = 0;
            
            setStatus('interviewStatus', 'testing', 'é¢è¯•è¿›è¡Œä¸­');
            document.getElementById('pauseBtn').style.display = 'inline-flex';
            document.getElementById('stopInterviewBtn').style.display = 'inline-flex';
            
            log('ğŸš€ å¼€å§‹æ¨¡æ‹Ÿé¢è¯•...');
            
            await nextQuestion();
        }

        // ä¸‹ä¸€ä¸ªé—®é¢˜
        async function nextQuestion() {
            if (!interviewActive || currentQuestion >= interviewQuestions.length) {
                completeInterview();
                return;
            }

            const question = interviewQuestions[currentQuestion];
            log(`ğŸ“ é—®é¢˜ ${currentQuestion + 1}: ${question}`);

            // æ›´æ–°è¿›åº¦
            const progress = ((currentQuestion + 1) / interviewQuestions.length) * 100;
            document.getElementById('interviewProgress').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `${currentQuestion + 1}/${interviewQuestions.length} é—®é¢˜`;

            try {
                // ç”Ÿæˆå¹¶æ’­æ”¾é—®é¢˜éŸ³é¢‘ - å°è¯•å¤šæ ¼å¼
                const endpoints = [
                    { url: 'http://localhost:8000/speech/synthesize-wav', format: 'WAV' },
                    { url: 'http://localhost:8000/speech/synthesize', format: 'MP3' }
                ];

                let audioPlayedSuccessfully = false;
                
                for (const endpoint of endpoints) {
                    try {
                        log(`ğŸµ ç”Ÿæˆ${endpoint.format}æ ¼å¼é—®é¢˜éŸ³é¢‘...`);
                        
                        const response = await fetch(endpoint.url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                text: question,
                                voice: 'nova',
                                speed: '1.0'
                            })
                        });

                        if (response.ok) {
                            const audioBlob = await response.blob();
                            const audioUrl = URL.createObjectURL(audioBlob);
                            const audio = new Audio(audioUrl);
                            
                            log(`ğŸ”Š æ’­æ”¾${endpoint.format}æ ¼å¼é¢è¯•é—®é¢˜...`);
                            await audio.play();
                            
                            // ç­‰å¾…æ’­æ”¾å®Œæˆåå¼€å§‹å½•åˆ¶ç”¨æˆ·å›ç­”
                            audio.onended = () => {
                                log('ğŸ¤ è¯·å¼€å§‹å›ç­”ï¼ˆè‡ªåŠ¨å½•åˆ¶10ç§’ï¼‰...');
                                simulateUserAnswer();
                            };
                            
                            audioPlayedSuccessfully = true;
                            break; // æˆåŠŸæ’­æ”¾ï¼Œé€€å‡ºå¾ªç¯
                        }
                    } catch (formatError) {
                        log(`âŒ ${endpoint.format}æ ¼å¼æ’­æ”¾å¤±è´¥: ${formatError.message}`);
                        continue; // å°è¯•ä¸‹ä¸€ä¸ªæ ¼å¼
                    }
                }
                
                if (!audioPlayedSuccessfully) {
                    log('âŒ æ‰€æœ‰éŸ³é¢‘æ ¼å¼æ’­æ”¾å¤±è´¥ï¼Œè·³è¿‡åˆ°ä¸‹ä¸€é¢˜');
                    setTimeout(nextQuestion, 2000);
                }
            } catch (error) {
                log(`âŒ é—®é¢˜å¤„ç†å¤±è´¥: ${error.message}`);
                setTimeout(nextQuestion, 2000);
            }
        }

        // æ¨¡æ‹Ÿç”¨æˆ·å›ç­”
        function simulateUserAnswer() {
            log('â° æ¨¡æ‹Ÿç”¨æˆ·å›ç­”æ—¶é—´...');
            
            // æ¨¡æ‹Ÿ10ç§’å›ç­”æ—¶é—´
            setTimeout(() => {
                log('âœ… ç”¨æˆ·å›ç­”å®Œæˆ');
                currentQuestion++;
                
                if (interviewActive) {
                    setTimeout(nextQuestion, 1000);
                }
            }, 3000); // ç¼©çŸ­åˆ°3ç§’ç”¨äºæ¼”ç¤º
        }

        // å®Œæˆé¢è¯•
        function completeInterview() {
            interviewActive = false;
            setStatus('interviewStatus', 'success', 'é¢è¯•å®Œæˆ');
            
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('stopInterviewBtn').style.display = 'none';
            
            log('ğŸ‰ é¢è¯•æµç¨‹æµ‹è¯•å®Œæˆï¼');
            log('ğŸ“Š æ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼Œæ‚¨çš„æµè§ˆå™¨å®Œå…¨æ”¯æŒVITAè¯­éŸ³é¢è¯•');
        }

        // æš‚åœé¢è¯•
        function pauseInterview() {
            interviewActive = false;
            setStatus('interviewStatus', 'ready', 'å·²æš‚åœ');
            log('â¸ï¸ é¢è¯•å·²æš‚åœ');
        }

        // åœæ­¢é¢è¯•
        function stopInterview() {
            interviewActive = false;
            currentQuestion = 0;
            setStatus('interviewStatus', 'ready', 'å·²åœæ­¢');
            
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('stopInterviewBtn').style.display = 'none';
            document.getElementById('interviewProgress').style.width = '0%';
            document.getElementById('progressText').textContent = '0/5 é—®é¢˜';
            
            log('ğŸ›‘ é¢è¯•æµ‹è¯•å·²åœæ­¢');
        }

        // è®¾ç½®çŠ¶æ€
        function setStatus(elementId, statusClass, text) {
            const element = document.getElementById(elementId);
            element.className = `status ${statusClass}`;
            element.textContent = text;
        }

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logPanel = document.getElementById('logPanel');
            const timestamp = new Date().toLocaleTimeString();
            logPanel.innerHTML += `\n[${timestamp}] ${message}`;
            logPanel.scrollTop = logPanel.scrollHeight;
        }
    </script>
</body>
</html> 